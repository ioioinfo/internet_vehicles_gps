<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>主页</title>
<link rel="stylesheet" href="css/font-awesome.min.css">
<script src="js/jquery-3.1.1.min.js"type="text/javascript"></script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.0&key=0c053bde775595e8b1b3de340265f053"></script>
<style media="screen">
*,p{
  padding: 0;
}
body{
  background: #dcdcdc;
}
  #container{
    float: left;
    width:60%;
    height:600px ;
  }
  .car_infor_list{
    float: right;
    width: 30%;

  }
  ul{
    width: 100%;
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-flex-wrap: wrap;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin: 0;
  }
  .car_infor_list li p{
    height: 21px;
    line-height: 21px;
    overflow: hidden;
    margin: 12px 0;
  }
  .car_infor_list li p span:last-child{
    float: right;
  }
  li{
    width: 100%;
    list-style: none;
    padding: 7px;
    background: #fff;
    border-right: 4px solid #dcdcdc;
    box-sizing: border-box;
    cursor: pointer;
    margin-bottom: 7px;
    border-radius: 6px;
    min-height: 158px;
  }
  @media screen and (min-width:1360px){
    #container{
      width: 810px;
    }
    li{
      margin-bottom: 7px;
      width: 50%;
    }
    .car_infor_list{
      min-width: 500px;
    }
  }

  @media screen and (max-width:890px){
    #container{
      width: 100%;
    }
    .car_infor_list{
      min-width: 100%;;
    }
    li{
      margin-bottom: 7px;
      width: 33.3%;
    }
  }
  @media screen and (max-width:768px){
    #container{
      width: 100%;
    }
    .car_infor_list{
      min-width: 100%;;
    }
    li{
      margin-bottom: 7px;
      width: 50%;
    }
  }
  @media screen and (max-width:665px){
    #container{
      width: 100%;
    }
    .car_infor_list{
      min-width: 100%;;
    }
    li{
      margin-bottom: 7px;
      width: 100%;
    }
  }
  i{
    margin: 0 30px;
    color: red;
  }
  .state0{
    color: #666;
  }
  .state1{
    color: red;
  }
  .car_titile{
    text-align: center;
  }
  .color{
    color: #666;
  }
  input{
    border: none;
    outline-style: none;
    padding: 7px 0 ;
    text-indent: 10px;
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
  }
  .input{
    margin: 17px 0;

  }
  button{
    padding: 5px 7px ;
    border: 1px solid #fff;
    background: #3388FF;
    color: #FFF;
    vertical-align: bottom;
  }
</style>
</head>
<body>
    <div id="container"></div>
    <div class="car_infor_list">
      <div class="input"><input type="text" placeholder="搜索"/><button>查找</button></div>
      <ul class="">

      {% for row in rows %}
          <li class="gps" data-id="{{ row.gps_id }}">
            <p class="car_titile"><i class="fa fa-car  state{{row.state}}"></i>{{ row.code }}</p>
            <p><span>车型：{{ row.car_brand }}</span> <span>颜色：{{ row.color }}</span></p>
            <p> <span>车牌：{{ row.plate_number }} </span><span >状态：<e class="state">{{ row.state }}</e></span></p>
            <p> 最新更新时间：{{ row.time }}</p>
          </li>
      {% endfor %}
      </ul>
    </div>



<script>
window.onload=function(){
  $('.input input').focus();
}
$(function(){
    var infoWindow;
    var vehicles = {{vehicles|safe}};

    //标记图片设置
    var icon = new AMap.Icon({
        image : 'images/car_gps.png',//24px*24px
        //icon可缺省，缺省时为默认的蓝色水滴图标，
        size : new AMap.Size(24,24),
        imageSize : new AMap.Size(24,24)
    });
    var icon2 = new AMap.Icon({
        image : 'images/bike.png',//24px*24px
        //icon可缺省，缺省时为默认的蓝色水滴图标，
        size : new AMap.Size(24,24),
        imageSize : new AMap.Size(24,24)
    });
    var icon3 = new AMap.Icon({
        image : 'images/autobike.png',//24px*24px
        //icon可缺省，缺省时为默认的蓝色水滴图标，
        size : new AMap.Size(24,24),
        imageSize : new AMap.Size(24,24)
    });
    var icon4 = new AMap.Icon({
        image : 'images/fly.png',//24px*24px
        //icon可缺省，缺省时为默认的蓝色水滴图标，
        size : new AMap.Size(24,24),
        imageSize : new AMap.Size(24,24)
    });
    var markers = {};
    var map;
    var location_map = {};
    $(".gps").click(function(){
        var gps_id = $(this).data("id");
        for (var i = 0; i < vehicles.length; i++) {
            if (vehicles[i].gps_id==gps_id) {
                console.log(location_map[gps_id].longitude+","+location_map[gps_id].latitude);
                map.setCenter([location_map[gps_id].longitude,location_map[gps_id].latitude]);
            }
        }
    });

    function init(){
        $.get("/get_lastest_records",function(data){
            if (data.success) {
                var rows = data.rows;
                //地图对象，中心位置，比例
                map = new AMap.Map('container', {
                    center: [rows[0].longitude,rows[0].latitude],
                    zoom: 12,
                });
                //地图工具，调节街市省，比例，鹰眼
                map.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"], function() {
                    map.addControl(new AMap.ToolBar());
                    // map.addControl(new AMap.Scale());
                    // map.addControl(new AMap.OverView({isOpen:true}));
                });
                //map.setZoomAndCenter(16, [rows[0].longitude,rows[0].latitude]);

                //信息框对象
                var infoWindow = new AMap.InfoWindow();
                for (var i = 0; i < rows.length; i++) {
                    location_map[rows[i].gps_id] = rows[i];
                    var marker;
                    //汽车标记
                    marker = new AMap.Marker({
                        icon : icon,//24px*24px
                        position : [rows[i].longitude,rows[i].latitude],
                        offset : new AMap.Pixel(-12,-12),
                        map : map
                    });
                    //弹出信息框
                    marker.content='我是第'+rows[i].gps_id+'GPS定位器';
                    marker.on('click',markerClick);
                    marker.emit('click',{target:marker});
                    markers[rows[i].gps_id] = marker;
                }
                //点击事件
                function markerClick(e){
                    infoWindow.setContent(e.target.content);
                    infoWindow.open(map, e.target.getPosition());
                    //设置地图中心点位置
                    map.setCenter(e.target.getPosition());
                };
                //map.setFitView();
                //点击事件
                // AMap.event.addListener(marker, 'click', function() {
                //     infoWindow.open(map, marker.getPosition());
                // })
                //构建信息窗体中显示的内容
                // var content=[];
                // content.push("GPS："+rows[i].gps_id);
                // content.push("纬度："+rows[i].longitude);
                // content.push("经度："+rows[i].latitude);
                // content.push('<a href="http://ditu.amap.com/detail/B000A8URXB?citycode=110105" target="_blank">详细信息</a>');
                //
                // infoWindow = new AMap.InfoWindow({
                //     content: content.join("<br>")  //使用默认信息窗体框样式，显示信息内容
                // });
                // infoWindow.open(map, map.getCenter());

                // setTimeout(vehicles_run,3000);

            }else {
                alert(data.message);
            };
        });
    };
    init();

    var vehicles_run = function(){
        for (var i = 0; i < vehicles.length; i++) {
            var vehicle = vehicles[i];
            if (markers[vehicle.gps_id]) {
                var maker = markers[vehicle.gps_id];
                maker.setIcon(icon4);
                maker.moveTo([122.438083000000,32.347179000000],300);
                var a = maker.getPosition();

            }
        }

        // var lastest_record = {
        //     "id":1,
        //     "gps_id":1,
        //     "longitude":"121.438083000000",
        //     "latitude":"31.347179000000",
        //     "time":"2017-09-13 11:53:00"
        // };
        // var history_record = {
        //     "gps_id":1,
        //     "longitude":"121.438083000000",
        //     "latitude":"31.347179000000",
        //     "time":"2017-09-13 11:53:00"
        // }
        // $.post("/update_lastest_record",{"lastest_record":JSON.stringify(lastest_record)},function(data){
        //     if (data.success) {
        //         $.post("/save_history_record",{"history_record":JSON.stringify(history_record)},function(data){
        //             if (data.success) {
        //                 init();
        //             }else {
        //                 alert(data.message);
        //             }
        //         });
        //     }else {
        //         alert(data.message);
        //     }
        // });

    };

})
</script>
</body>
</html>
